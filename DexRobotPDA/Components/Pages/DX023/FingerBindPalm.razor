@page "/DX023FingerBindPalm"
@page "/DX023FingerBindPalm/{task_id}/{palm_id}"
@using System.Text.Json
@using System.Text.RegularExpressions
@implements IAsyncDisposable

<MudPaper Elevation="3" MaxWidth="1000px" Class="pa-4 ma-2 mx-auto">
    <div class="min-vh-40 d-flex flex-column justify-center">
        @if (!hasSearched)
        {
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="text-center">
                请输入生产单号并点击查询，加载任务详情
            </MudText>
        }
        else if (isLoading)
        {
            <div class="d-flex justify-content-center align-items-center">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
            </div>
        }
        else if (task == null)
        {
            <div class="d-flex justify-content-center align-items-center text-center">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Medium" Class="mr-3"/>
                <MudText Typo="Typo.body1" Color="Color.Error">
                    无法加载任务数据，请检查生产单号是否正确
                </MudText>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(palm_id))
            {
                <BarcodeScanner
                    @ref="scanner"
                    Inputs="scannerInputs"
                    DetermineTargetInput="DetermineTargetInput"
                    OnInputValueChanged="HandleInputValueChanged"
                    DuplicateCheckInputIds="DuplicateCheckList"
                    DuplicateErrorMessage="编号重复"/>
                <MudDivider Class="my-4"/>
                <MudButton OnClick="HandleUpdateDemo" Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary"
                           FullWidth="true" Disabled="@isBinding">
                    @if (isBinding)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ml-2">更新中...</MudText>
                    }
                    else
                    {
                        <MudText>更新</MudText>
                    }
                </MudButton>
            }
            else if (finishedPalms.Count == task.product_num)
            {
                <div class="d-flex flex-row align-center my-6">
                    <MudText Typo="Typo.h6" Class="text-primary mr-4">该任务已完成</MudText>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled"
                               OnClick="NavigateToDetail"
                               Color="Color.Primary">
                        查看明细
                    </MudButton>
                </div>
            }
            else
            {
                <MudStack Row="true" Spacing="4" Class="d-flex align-center py-2">
                    <MudButton
                        Variant="Variant.Outlined"
                        Color="@(ScannerService.IsAutoMode ? Color.Success : Color.Primary)"
                        OnClick="ToggleScanModeAsync"
                        Size="Size.Medium">
                        @(ScannerService.IsAutoMode ? "自动匹配模式" : "手动聚焦模式")
                        <MudIcon
                            Icon="@(ScannerService.IsAutoMode ? Icons.Material.Filled.AutoAwesome : Icons.Material.Filled.Man)"
                            Class="ml-2"/>
                    </MudButton>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled"
                               OnClick="@NavigateToDetail"
                               Color="Color.Primary">
                        已完成数量@(finishedPalms.Count)/@task.product_num
                    </MudButton>
                </MudStack>

                <BarcodeScanner
                    @ref="scanner"
                    Inputs="scannerInputs"
                    DetermineTargetInput="DetermineTargetInput"
                    OnInputValueChanged="HandleInputValueChanged"
                    DuplicateCheckInputIds="DuplicateCheckList"
                    DuplicateErrorMessage="编号重复"/>
                <MudDivider Class="my-4"/>
                <MudButton OnClick="@HandleBinding" Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary"
                           FullWidth="true" Disabled="@isBinding">
                    @if (isBinding)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ml-2">绑定中...</MudText>
                    }
                    else
                    {
                        <MudText>绑定</MudText>
                    }
                </MudButton>
            }
        }
    </div>

    <MudDivider Class="my-4"/>

    <MudStack Row="true" Spacing="4" Class="d-flex align-center py-2">
        <MudTextField
            @bind-Value="taskId"
            Label="生产单号"
            Variant="Variant.Outlined"
            Required="true"
            Disabled="!string.IsNullOrEmpty(palm_id)"
            Clearable="true"
            Error="@hasInputError"
            ErrorText="请输入生产单号"
            AutoFocus="true"
            Id="taskId"
            @onfocus="() => HandleSpecialInputFocus()"
            @onblur="() => HandleSpecialInputBlur()"
            Class="flex-1"/>

        <MudButton
            Variant="Variant.Filled"
            Color="Color.Error"
            Disabled="!string.IsNullOrEmpty(palm_id)"
            StartIcon="@Icons.Material.Filled.DeleteForever"
            OnClick="ClearTaskId"
            Size="Size.Large"
            Class="w-full md:w-auto">
            清除
        </MudButton>

        <MudButton
            Variant="Variant.Filled"
            Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.Search"
            OnClick="LoadTaskDetail"
            Size="Size.Large"
            Disabled="@(isLoading || !string.IsNullOrEmpty(palm_id))"
            Class="w-full md:w-auto">
            @(isLoading ? "查询中..." : "查询")
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private const string StorageKey = "process3_taskId";

    // ✅ 新产品手指编码：MO-YYYYMMDD-XXX-####（无 D/M/F/L/R）
    private static readonly Regex FingerCodeRegex =
        new(@"^MO-\d{8}-\d{3}-\d{4}$", RegexOptions.IgnoreCase | RegexOptions.Compiled);

    private const string FingerFormatError = "手指编码格式错误，应为：MO-YYYYMMDD-XXX-####";

    // 手掌外壳前缀（设为 "" 可关闭 palmId 前缀校验）
    private const string PalmPrefix = "DX";
    private const string PalmPrefixError = "手掌外壳编号格式错误，应以 DX 开头";

    [Parameter] public string task_id { get; set; }
    [Parameter] public string palm_id { get; set; }

    private string taskId = string.Empty;
    private ProductTaskDto? task = null;
    private bool isLoading = false;
    private bool hasSearched = false;
    private bool hasInputError = false;
    private UserDto? currentUser;
    private List<PalmDto> finishedPalms = new();

    private AddPalmDto _PalmDto = new();

    // ✅ 新产品：3 根手指
    private string _fixedFinger = string.Empty; // 固定手指
    private string _rotate1 = string.Empty;     // 旋转手指1
    private string _rotate2 = string.Empty;     // 旋转手指2

    // ✅ 新增：旋转舵机
    private string _rotateServo = string.Empty;

    private DotNetObjectReference<FingerBindPalm>? dotNetRef;

    private BarcodeScanner? scanner;
    private List<BarcodeScanner.InputField> scannerInputs = new();

    // ✅ 去重字段（3指 + 舵机）
    private readonly List<string> DuplicateCheckList = new() { "rotateServo", "fixedFinger", "rotateFinger1", "rotateFinger2" };

    private bool isBinding = false;

    // ✅ 聚焦：等待渲染完成后执行
    private string? _pendingFocusId;

    private static string Norm(string? s) => (s ?? string.Empty).Trim();

    private string GetFirstEditableInputId()
        => scannerInputs
            .Where(i => i.Visible && !i.Disable)
            .OrderBy(i => i.Index)
            .Select(i => i.Id)
            .FirstOrDefault() ?? "palmId";

    private void RequestFocusToFirstInput()
    {
        _pendingFocusId = GetFirstEditableInputId();
        StateHasChanged();
    }

    private async Task FocusInputById(string id, bool selectAll = true)
    {
        if (scanner is null) return;

        await ScannerService.ExitAutoFocusModeAsync();
        await Task.Yield();
        await Task.Delay(50);

        await scanner.FocusByIdAsync(id, selectAll);
        ScannerService.SetCurrentFocusedInputId(id);

        if (ScannerService.IsAutoMode)
            await ScannerService.EnterAutoFocusModeAsync();
    }

    private void SetFieldError(string fieldId, bool isError, string? errorText = null)
    {
        var input = scannerInputs.FirstOrDefault(i => i.Id == fieldId);
        if (input == null) return;
        input.Error = isError;
        input.ErrorText = isError ? (errorText ?? "") : "";
    }

    // ✅ 字段校验（空值不报错）
    // - palmId：前缀校验
    // - 3指：按 FingerCodeRegex 校验
    // - 舵机：这里不做格式正则（因为你没给编码规则），只做“非空必填”在 HandleBinding 里做
    private void ValidateField(string fieldId)
    {
        var input = scannerInputs.FirstOrDefault(i => i.Id == fieldId);
        if (input == null) return;

        var val = Norm(input.Value);
        if (string.IsNullOrEmpty(val))
        {
            SetFieldError(fieldId, false);
            return;
        }

        if (fieldId == "palmId")
        {
            if (string.IsNullOrEmpty(PalmPrefix))
            {
                SetFieldError(fieldId, false);
            }
            else
            {
                bool ok = val.StartsWith(PalmPrefix, StringComparison.OrdinalIgnoreCase);
                SetFieldError(fieldId, !ok, ok ? null : PalmPrefixError);
            }
            return;
        }

        if (fieldId is "fixedFinger" or "rotateFinger1" or "rotateFinger2")
        {
            bool ok = FingerCodeRegex.IsMatch(val);
            SetFieldError(fieldId, !ok, ok ? null : FingerFormatError);
            return;
        }

        if (fieldId == "rotateServo")
        {
            // 你没给舵机编码规则：这里只要非空就不报错
            SetFieldError(fieldId, false);
            return;
        }
    }

    private async Task ToggleScanModeAsync()
    {
        await ScannerService.ToggleModeAsync();
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(task_id) && !string.IsNullOrEmpty(palm_id))
        {
            await ScannerService.ToggleModeAsync2(false);
            StateHasChanged();
            taskId = task_id;
            await LoadTaskDetail();

            var list = await ProcessThreeService.GetPalmDetail(palm_id);

            // ✅ 约定：GetPalmDetail 返回顺序（你如不一致，告诉我我再改索引）：
            // [0]=rotateServo, [1]=fixedFinger, [2]=rotateFinger1, [3]=rotateFinger2, [4]=remarks
            var map = new Dictionary<string, int>
            {
                { "palmId", -1 },
                { "rotateServo", 0 },
                { "fixedFinger", 1 },
                { "rotateFinger1", 2 },
                { "rotateFinger2", 3 },
                { "remarks", 4 }
            };

            foreach (var kv in map)
            {
                var input = scannerInputs.FirstOrDefault(i => i.Id == kv.Key);
                if (input != null)
                {
                    input.Value = kv.Key == "palmId"
                        ? palm_id
                        : (list.Count > kv.Value && kv.Value >= 0 ? list[kv.Value] : "");
                }
            }

            if (scanner is not null) await scanner.RevalidateDuplicates();

            ValidateField("palmId");
            ValidateField("rotateServo");
            ValidateField("fixedFinger");
            ValidateField("rotateFinger1");
            ValidateField("rotateFinger2");

            RequestFocusToFirstInput();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // ✅ 新增：旋转舵机输入框（放在手掌后、手指前，方便扫码顺序）
        scannerInputs = new List<BarcodeScanner.InputField>
        {
            new BarcodeScanner.InputField { Index = 1, Label = "手掌外壳编号", Id = "palmId", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 2, Label = "旋转舵机编号", Id = "rotateServo", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 3, Label = "固定手指编号", Id = "fixedFinger", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 4, Label = "旋转手指 1 编号", Id = "rotateFinger1", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 5, Label = "旋转手指 2 编号", Id = "rotateFinger2", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 6, Label = "备注", Id = "remarks", IsSpecialInput = true }
        };

        await Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isLoading = true;
            StateHasChanged();
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("enterKeyHandler.initialize", dotNetRef);
            try
            {
                currentUser = await AuthService.GetCurrentUserAsync();
                if (currentUser == null)
                {
                    NavManager.NavigateTo("/login", true);
                    return;
                }

                _PalmDto.operator_id = currentUser.employee_id;

                if (string.IsNullOrWhiteSpace(taskId))
                {
                    var saved = await JSRuntime.InvokeAsync<string>("localStorage.getItem", StorageKey);
                    if (!string.IsNullOrWhiteSpace(saved))
                    {
                        taskId = saved;
                        hasSearched = true;
                        await LoadTaskDetail();
                    }
                }
            }
            catch
            {
                NavManager.NavigateTo("/login", true);
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }

        if (!firstRender && _pendingFocusId is not null)
        {
            var id = _pendingFocusId;
            _pendingFocusId = null;
            await FocusInputById(id, selectAll: true);
        }
    }

    private void HandleSpecialInputFocus()
    {
        ScannerService.SetCurrentFocusedInputId("taskId");
        _ = ScannerService.ExitAutoFocusModeAsync();
    }

    private async Task HandleSpecialInputBlur()
    {
        if (ScannerService.IsAutoMode) await ScannerService.EnterAutoFocusModeAsync();
        await ScannerService.HandleInputBlurAsync();
    }

    private async Task ClearTaskId()
    {
        taskId = string.Empty;
        task = null;
        hasSearched = false;
        hasInputError = false;
        finishedPalms.Clear();
        _PalmDto = new AddPalmDto();

        foreach (var input in scannerInputs) input.Value = string.Empty;

        _rotateServo = _fixedFinger = _rotate1 = _rotate2 = string.Empty;

        if (currentUser != null) _PalmDto.operator_id = currentUser.employee_id;

        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", StorageKey);
        StateHasChanged();

        if (scanner is not null) await scanner.RevalidateDuplicates();

        ValidateField("palmId");
        ValidateField("rotateServo");
        ValidateField("fixedFinger");
        ValidateField("rotateFinger1");
        ValidateField("rotateFinger2");
    }

    private async Task LoadTaskDetail()
    {
        if (string.IsNullOrWhiteSpace(taskId))
        {
            hasInputError = true;
            StateHasChanged();
            return;
        }

        hasInputError = false;
        isLoading = true;
        StateHasChanged();
        try
        {
            hasSearched = true;
            StateHasChanged();
            task = await TaskService.GetTaskDetail(taskId);
            if (task == null) SnackbarHelper.Show(Snackbar, "生产单号不存在", Severity.Warning);

            _PalmDto.task_id = taskId;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", StorageKey, taskId);
            await GetFinishedList();

            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            task = null;
            await DialogService.ShowMessageBox("错误", $"任务加载失败：{ex.Message}", "确定");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GetFinishedList()
    {
        try
        {
            var result = await ProcessThreeService.GetPalmList(taskId);
            finishedPalms = result;
            if (task != null)
            {
                if (finishedPalms.Count >= task.product_num)
                    await TaskService.UpdateTaskProcessStatus(taskId, "process7", 1);
                else
                    await TaskService.UpdateTaskProcessStatus(taskId, "process7", 0);
            }
        }
        catch
        {
            finishedPalms = new List<PalmDto>();
            SnackbarHelper.Show(Snackbar, "加载失败", Severity.Error);
        }
    }

    private async Task NavigateToDetail()
    {
        if (!string.IsNullOrWhiteSpace(taskId))
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", StorageKey, taskId);
        NavManager.NavigateTo($"/DX023TaskDetail/{taskId}/{2}");
    }

    private async Task HandleBinding()
    {
        var palmInput = scannerInputs.FirstOrDefault(i => i.Id == "palmId");
        var servoInput = scannerInputs.FirstOrDefault(i => i.Id == "rotateServo");
        var fixedInput = scannerInputs.FirstOrDefault(i => i.Id == "fixedFinger");
        var r1Input = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger1");
        var r2Input = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger2");
        var remarksInput = scannerInputs.FirstOrDefault(i => i.Id == "remarks");

        if (palmInput == null || string.IsNullOrWhiteSpace(palmInput.Value))
        {
            SnackbarHelper.Show(Snackbar, "手掌外壳ID不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }
        if (servoInput == null || string.IsNullOrWhiteSpace(servoInput.Value))
        {
            SnackbarHelper.Show(Snackbar, "旋转舵机编号不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }
        if (fixedInput == null || string.IsNullOrWhiteSpace(fixedInput.Value))
        {
            SnackbarHelper.Show(Snackbar, "固定手指编号不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }
        if (r1Input == null || string.IsNullOrWhiteSpace(r1Input.Value))
        {
            SnackbarHelper.Show(Snackbar, "旋转手指 1 编号不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }
        if (r2Input == null || string.IsNullOrWhiteSpace(r2Input.Value))
        {
            SnackbarHelper.Show(Snackbar, "旋转手指 2 编号不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        ValidateField("palmId");
        ValidateField("rotateServo");
        ValidateField("fixedFinger");
        ValidateField("rotateFinger1");
        ValidateField("rotateFinger2");

        bool hasFormatError = scannerInputs.Any(i =>
            (i.Id == "palmId" || i.Id == "fixedFinger" || i.Id == "rotateFinger1" || i.Id == "rotateFinger2")
            && i.Error && !string.IsNullOrWhiteSpace(i.ErrorText));

        if (hasFormatError)
        {
            SnackbarHelper.Show(Snackbar, "存在编号格式错误，请修正后再绑定", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        if (scannerInputs.Where(i => DuplicateCheckList.Contains(i.Id))
            .Any(i => i.Error && !string.IsNullOrWhiteSpace(i.ErrorText)))
        {
            SnackbarHelper.Show(Snackbar, "存在重复编号（舵机/手指），请先修改后再绑定", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        isBinding = true;
        try
        {
            _PalmDto.palm_id = palmInput.Value;
            _PalmDto.remarks = remarksInput?.Value ?? "";

            // ✅ 先绑定手掌 + 手指（你原本的接口）
            var componentIds = new List<string>
            {
                fixedInput.Value,
                r1Input.Value,
                r2Input.Value
            };

            var palmWithComponentsDto = new AddPalmWithComponentsDto
            {
                palm_id = _PalmDto.palm_id,
                task_id = _PalmDto.task_id,
                operator_id = _PalmDto.operator_id,
                remarks = _PalmDto.remarks,
                component_ids = componentIds
            };

            var palmResponse = await ProcessThreeService.AddPalmWithComponents(palmWithComponentsDto);

            if (palmResponse.ResultCode != 1)
            {
                SnackbarHelper.Show(Snackbar, $"手掌绑定失败：{palmResponse?.Msg ?? "未知错误"}", Severity.Error);
                RequestFocusToFirstInput();
                return;
            }

            AddServoDto servoDto = new AddServoDto()
            {
                servo_id = servoInput.Value,
                superior_id = _PalmDto.palm_id,
                task_id = _PalmDto.task_id,
                operator_id = currentUser.employee_id,
                type = 2
            };
            // ✅ 再绑定旋转舵机：预留 API 调用位置（你自己填写）
            var servoBindResp = await IPartService.AddServoAsync(servoDto);

            if (servoBindResp != null && servoBindResp.ResultCode != 1)
            {
                // 这里不回滚你已有绑定逻辑（保持和你现有风格一致）
                SnackbarHelper.Show(Snackbar, $"舵机绑定失败：{servoBindResp.Msg}", Severity.Error);
                RequestFocusToFirstInput();
                return;
            }

            // ✅ 清空表单
            palmInput.Value = servoInput.Value = fixedInput.Value = r1Input.Value = r2Input.Value = "";
            if (remarksInput != null) remarksInput.Value = "";

            if (scanner is not null) await scanner.RevalidateDuplicates();

            await LoadTaskDetail();
            await TaskService.UpdateSingleTaskStatus(taskId);
            SnackbarHelper.Show(Snackbar, "手掌 + 舵机 + 三指绑定成功", Severity.Success);

            RequestFocusToFirstInput();
        }
        catch (JsonException jsonEx)
        {
            SnackbarHelper.Show(Snackbar, $"数据解析失败: {jsonEx.Message}", Severity.Error);
            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            SnackbarHelper.Show(Snackbar, $"绑定异常：{ex.Message}", Severity.Error);
            RequestFocusToFirstInput();
        }
        finally
        {
            isBinding = false;
            StateHasChanged();
        }
    }

    private async Task HandleUpdateDemo()
    {
        var palmInput = scannerInputs.FirstOrDefault(i => i.Id == "palmId");
        var servoInput = scannerInputs.FirstOrDefault(i => i.Id == "rotateServo");
        var fixedInput = scannerInputs.FirstOrDefault(i => i.Id == "fixedFinger");
        var r1Input = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger1");
        var r2Input = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger2");
        var remarksInput = scannerInputs.FirstOrDefault(i => i.Id == "remarks");

        if (palmInput == null || string.IsNullOrWhiteSpace(palmInput.Value))
        {
            SnackbarHelper.Show(Snackbar, "手掌外壳ID不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        try
        {
            var originalData = await ProcessThreeService.GetPalmDetail(palmInput.Value);

            var newServo = servoInput?.Value ?? "";
            var newFixed = fixedInput?.Value ?? "";
            var newR1 = r1Input?.Value ?? "";
            var newR2 = r2Input?.Value ?? "";

            // 对应上面回填约定顺序：
            var oldServo = originalData.Count > 0 ? originalData[0] : "";
            var oldFixed = originalData.Count > 1 ? originalData[1] : "";
            var oldR1 = originalData.Count > 2 ? originalData[2] : "";
            var oldR2 = originalData.Count > 3 ? originalData[3] : "";

            await CheckAndShowFingerChange("旋转舵机", oldServo, newServo);
            await CheckAndShowFingerChange("固定手指", oldFixed, newFixed);
            await CheckAndShowFingerChange("旋转手指1", oldR1, newR1);
            await CheckAndShowFingerChange("旋转手指2", oldR2, newR2);

            if (scanner is not null) await scanner.RevalidateDuplicates();

            ValidateField("palmId");
            ValidateField("rotateServo");
            ValidateField("fixedFinger");
            ValidateField("rotateFinger1");
            ValidateField("rotateFinger2");

            SnackbarHelper.Show(Snackbar, "更新检查完成", Severity.Success);
            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            SnackbarHelper.Show(Snackbar, $"检查异常：{ex.Message}", Severity.Error);
            RequestFocusToFirstInput();
        }
    }

    private async Task CheckAndShowFingerChange(string name, string oldValue, string newValue)
    {
        if (oldValue != newValue)
        {
            if (!string.IsNullOrEmpty(oldValue))
            {
                var unbindResponse = await ProcessTwoService.UnBindFinger(oldValue);
                if (unbindResponse.ResultCode != 1)
                {
                    SnackbarHelper.Show(Snackbar, $"{name}解绑失败: {unbindResponse.Msg}", Severity.Error);
                    return;
                }
            }

            if (!string.IsNullOrEmpty(newValue))
            {
                var rebindResponse = await ProcessTwoService.ReBindFinger(newValue, taskId, palm_id);
                if (rebindResponse.ResultCode != 1)
                {
                    SnackbarHelper.Show(Snackbar, $"{name}重绑失败: {rebindResponse.Msg}", Severity.Error);
                    return;
                }
            }

            SnackbarHelper.Show(Snackbar, $"{name}从'{oldValue}'变更为'{newValue}'", Severity.Info);
        }
    }

    // ✅ 自动匹配规则：
    // - 手指码（MO-...） -> 按 固定 -> 旋转1 -> 旋转2 填空位
    // - 其它：按空位顺序（palm -> servo -> fingers -> remarks）
    private BarcodeScanner.InputField? DetermineTargetInput(string barcodeData)
    {
        var code = Norm(barcodeData);

        if (FingerCodeRegex.IsMatch(code))
        {
            var fixedEmpty = scannerInputs.FirstOrDefault(i => i.Id == "fixedFinger" && string.IsNullOrEmpty(Norm(i.Value)));
            if (fixedEmpty != null) return fixedEmpty;

            var r1Empty = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger1" && string.IsNullOrEmpty(Norm(i.Value)));
            if (r1Empty != null) return r1Empty;

            var r2Empty = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger2" && string.IsNullOrEmpty(Norm(i.Value)));
            if (r2Empty != null) return r2Empty;

            return scannerInputs.FirstOrDefault(i => i.Id == "fixedFinger");
        }

        var palmEmpty = scannerInputs.FirstOrDefault(i => i.Id == "palmId" && string.IsNullOrEmpty(Norm(i.Value)));
        if (palmEmpty != null) return palmEmpty;

        var servoEmpty = scannerInputs.FirstOrDefault(i => i.Id == "rotateServo" && string.IsNullOrEmpty(Norm(i.Value)));
        if (servoEmpty != null) return servoEmpty;

        var fixedE = scannerInputs.FirstOrDefault(i => i.Id == "fixedFinger" && string.IsNullOrEmpty(Norm(i.Value)));
        if (fixedE != null) return fixedE;

        var r1E = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger1" && string.IsNullOrEmpty(Norm(i.Value)));
        if (r1E != null) return r1E;

        var r2E = scannerInputs.FirstOrDefault(i => i.Id == "rotateFinger2" && string.IsNullOrEmpty(Norm(i.Value)));
        if (r2E != null) return r2E;

        return scannerInputs.FirstOrDefault(i => i.Id == "remarks");
    }

    private async Task HandleInputValueChanged(BarcodeScanner.InputField input)
    {
        switch (input.Id)
        {
            case "palmId": _PalmDto.palm_id = input.Value; break;
            case "rotateServo": _rotateServo = input.Value; break;
            case "fixedFinger": _fixedFinger = input.Value; break;
            case "rotateFinger1": _rotate1 = input.Value; break;
            case "rotateFinger2": _rotate2 = input.Value; break;
            case "remarks": _PalmDto.remarks = input.Value; break;
        }

        ValidateField(input.Id);
        await Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetRef != null)
        {
            await JSRuntime.InvokeVoidAsync("enterKeyHandler.dispose");
            dotNetRef.Dispose();
        }

        GC.SuppressFinalize(this);
    }
}

@inject BarcodeScannerService ScannerService
@inject ISnackbar Snackbar
