@page "/DX023ServoBindFinger"
@page "/DX023ServoBindFinger/{task_id}/{finger_id}"

@using System.Text.Json
@using System.Text.RegularExpressions
@implements IAsyncDisposable

<MudPaper Elevation="3" MaxWidth="1000px" Class="pa-4 ma-2 mx-auto">
    <div class="min-vh-40 d-flex flex-column justify-center">
        @if (!hasSearched)
        {
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="text-center">
                请输入生产单号并点击查询，加载任务详情
            </MudText>
        }
        else if (isLoading)
        {
            <div class="d-flex justify-content-center align-items-center">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
            </div>
        }
        else if (task == null)
        {
            <div class="d-flex justify-content-center align-items-center text-center">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Medium" Class="mr-3"/>
                <MudText Typo="Typo.body1" Color="Color.Error">
                    无法加载任务数据，请检查生产单号是否正确
                </MudText>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(finger_id))
            {
                <BarcodeScanner
                    @ref="scanner"
                    Inputs="scannerInputs"
                    DetermineTargetInput="DetermineTargetInput"
                    OnInputBlur="HandleAnyInputBlur"
                    DuplicateCheckInputIds="DuplicateCheckList"
                    DuplicateErrorMessage="舵机编号重复"
                    OnInputValueChanged="HandleInputValueChanged"/>
                <MudDivider Class="my-4"/>
                <MudButton OnClick="HandleUpdateDemo" Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary"
                           FullWidth="true" Disabled="@isBinding">
                    @if (isBinding)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ml-2">更新中...</MudText>
                    }
                    else
                    {
                        <MudText>更新</MudText>
                    }
                </MudButton>
            }
            else if (finishedFingers.Count == (task.product_num * 3))
            {
                <div class="d-flex flex-row align-center my-6">
                    <MudText Typo="Typo.h6" Class="text-primary mr-4">该任务已完成</MudText>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled"
                               OnClick="@NavigateToDetail"
                               Color="Color.Primary">
                        查看明细
                    </MudButton>
                </div>
            }
            else
            {
                <MudStack Row="true" Spacing="4" Class="d-flex align-center py-2">
                    <MudButton
                        Variant="Variant.Outlined"
                        Color="@(ScannerService.IsAutoMode ? Color.Success : Color.Primary)"
                        OnClick="ToggleScanModeAsync"
                        Size="Size.Medium">
                        @(ScannerService.IsAutoMode ? "自动匹配模式" : "手动聚焦模式")
                        <MudIcon
                            Icon="@(ScannerService.IsAutoMode ? Icons.Material.Filled.AutoAwesome : Icons.Material.Filled.Man)"
                            Class="ml-2"/>
                    </MudButton>
                    <MudSpacer/>

                    <MudButton Variant="Variant.Filled"
                               Color="@(_fingerDto.type == 3 ? Color.Error : Color.Default)"
                               OnClick="@(async () => await SetFingerTypeAsync(3))">
                        单舵机手指
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="@(_fingerDto.type == 4 ? Color.Error : Color.Default)"
                               OnClick="@(async () => await SetFingerTypeAsync(4))">
                        双舵机手指
                    </MudButton>

                    <MudDivider Vertical="true" Class="mx-4 my-auto" Style="height: 1em; align-self: center;"/>
                    <MudButton Variant="Variant.Filled"
                               OnClick="@NavigateToDetail"
                               Color="Color.Primary">
                        已绑定数量@(finishedFingers.Count)/@(task.product_num * 3)
                    </MudButton>
                </MudStack>

                <BarcodeScanner
                    @ref="scanner"
                    Inputs="scannerInputs"
                    DetermineTargetInput="DetermineTargetInput"
                    OnInputBlur="HandleAnyInputBlur"
                    DuplicateCheckInputIds="DuplicateCheckList"
                    DuplicateErrorMessage="舵机编号重复"
                    OnInputValueChanged="HandleInputValueChanged"/>
                <MudDivider Class="my-4"/>
                <MudButton OnClick="HandleBinding" Size="Size.Large" Variant="Variant.Filled" Color="Color.Primary"
                           FullWidth="true" Disabled="@isBinding">
                    @if (isBinding)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ml-2">绑定中...</MudText>
                    }
                    else
                    {
                        <MudText>绑定</MudText>
                    }
                </MudButton>
            }
        }
    </div>

    <MudDivider Class="my-4"/>
    <MudStack Row="true" Spacing="4" Class="d-flex align-center py-2">
        <MudTextField
            @bind-Value="taskId"
            Label="生产单号"
            Variant="Variant.Outlined"
            Required="true"
            Clearable="true"
            Disabled="!string.IsNullOrEmpty(finger_id)"
            Error="@hasInputError"
            AutoFocus="true"
            ErrorText="请输入生产单号"
            Id="taskId"
            @onfocus="() => HandleSpecialInputFocus()"
            @onblur="() => HandleSpecialInputBlur()"
            Class="flex-1"/>
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Error"
            Disabled="!string.IsNullOrEmpty(finger_id)"
            StartIcon="@Icons.Material.Filled.DeleteForever"
            OnClick="ClearTaskId"
            Size="Size.Large"
            Class="w-full md:w-auto">
            清除
        </MudButton>
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.Search"
            OnClick="LoadTaskDetail"
            Disabled="@(isLoading || !string.IsNullOrEmpty(finger_id))"
            Size="Size.Large"
            Class="w-full md:w-auto">
            @(isLoading ? "查询中..." : "查询")
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private const string StorageKey = "process2_taskId";

    // ===== Servo 前缀校验 =====
    private const string ServoPrefix = "R003D0";
    private const string RotaryServoPrefix = "S009F0";
    private const string ServoPrefixError = "舵机编号格式错误，应以 R003D0(普通舵机) 或 S009F0(旋转舵机) 开头";

    [Parameter] public string task_id { get; set; }
    [Parameter] public string finger_id { get; set; }

    private string taskId = string.Empty;
    private ProductTaskDto? task = null;
    private bool isLoading = false;
    private bool hasSearched = false;
    private bool hasInputError = false;

    private UserDto? currentUser;
    private List<FingerDto> finishedFingers = new List<FingerDto>();

    private MudForm form;
    private bool validation = true;

    // type=3 单舵机；type=4 双舵机
    private AddFingerDto _fingerDto = new AddFingerDto { type = 3 };

    private string _servoId1 { get; set; } = string.Empty;
    private string _servoId2 { get; set; } = string.Empty;

    private DotNetObjectReference<ServoBindFinger>? dotNetRef;
    private BarcodeScanner? scanner;
    private List<BarcodeScanner.InputField> scannerInputs = new();

    private List<string> DuplicateCheckList = new() { "servoId1", "servoId2" };
    private bool isBinding = false;

    private string? _pendingFocusId;

    // ✅ 手指编号校验：与你上一个页面一致（无 M/F/L/R 等识别）
    // 格式：MO-YYYYMMDD-XXX-#### 例如 MO-20251224-001-0001
    private static readonly Regex FingerCodeRegex =
        new(@"^MO-\d{8}-\d{3}-\d{4}$", RegexOptions.IgnoreCase | RegexOptions.Compiled);

    private const string FingerFormatError = "手指编号格式错误，应为：MO-YYYYMMDD-XXX-####";

    private string GetFirstEditableInputId()
        => scannerInputs
           .Where(i => i.Visible && !i.Disable)
           .OrderBy(i => i.Index)
           .Select(i => i.Id)
           .FirstOrDefault() ?? "fingerId";

    private void RequestFocusToFirstInput()
    {
        _pendingFocusId = GetFirstEditableInputId();
        StateHasChanged();
    }

    private async Task FocusInputById(string id, bool selectAll = true)
    {
        if (scanner is null) return;

        await ScannerService.ExitAutoFocusModeAsync();
        await Task.Yield();
        await Task.Delay(50);

        await scanner.FocusByIdAsync(id, selectAll);
        ScannerService.SetCurrentFocusedInputId(id);

        if (ScannerService.IsAutoMode)
            await ScannerService.EnterAutoFocusModeAsync();
    }

    private static string Norm(string? s) => (s ?? string.Empty).Trim();

    private void SetFieldError(string fieldId, bool isError, string? errorText = null)
    {
        var input = scannerInputs.FirstOrDefault(i => i.Id == fieldId);
        if (input == null) return;
        input.Error = isError;
        input.ErrorText = isError ? (errorText ?? "") : "";
    }

    // ✅ 校验：finger 用新正则；servo 用前缀校验
    private void ValidatePrefixForField(string fieldId)
    {
        var input = scannerInputs.FirstOrDefault(i => i.Id == fieldId);
        if (input == null) return;

        string val = Norm(input.Value);
        if (string.IsNullOrEmpty(val))
        {
            SetFieldError(fieldId, false);
            return;
        }

        if (fieldId == "fingerId")
        {
            bool ok = FingerCodeRegex.IsMatch(val);
            SetFieldError(fieldId, !ok, ok ? null : FingerFormatError);
            return;
        }

        if (fieldId == "servoId1" || fieldId == "servoId2")
        {
            bool ok = val.StartsWith(ServoPrefix, StringComparison.OrdinalIgnoreCase)
                      || val.StartsWith(RotaryServoPrefix, StringComparison.OrdinalIgnoreCase);
            SetFieldError(fieldId, !ok, ok ? null : ServoPrefixError);
            return;
        }
    }

    private async Task ToggleScanModeAsync()
    {
        await ScannerService.ToggleModeAsync();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // 参数模式：直接加载 task / finger 明细
        if (!string.IsNullOrEmpty(task_id) && !string.IsNullOrEmpty(finger_id))
        {
            taskId = task_id;
            await LoadTaskDetail();

            // 你自己接接口：这里假设返回 list：servo1, servo2(可选), remarks(可选最后一项)
            var list = await ProcessTwoService.GetFingerDetail(finger_id);

            _servoId1 = list.Count > 0 ? list[0] : string.Empty;
            _servoId2 = list.Count > 1 ? list[1] : string.Empty;

            // type 推断：>1 表示双舵机，否则单舵机
            _fingerDto.type = list.Count > 1 ? 4 : 3;
        }

        scannerInputs = new List<BarcodeScanner.InputField>
        {
            new BarcodeScanner.InputField { Index = 1, Label = "手指编号", Id = "fingerId", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 2, Label = "舵机1编号", Id = "servoId1", IsSpecialInput = false },
            new BarcodeScanner.InputField { Index = 3, Label = "舵机2编号(双舵机手指)", Id = "servoId2", IsSpecialInput = false, Visible = (_fingerDto.type == 4) },
            new BarcodeScanner.InputField { Index = 4, Label = "备注", Id = "remarks", IsSpecialInput = true }
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(task_id) && !string.IsNullOrEmpty(finger_id))
        {
            await ScannerService.ToggleModeAsync2(false);
            StateHasChanged();

            taskId = task_id;
            await LoadTaskDetail();

            var list = await ProcessTwoService.GetFingerDetail(finger_id);

            var inputValues = new Dictionary<string, string>
            {
                { "fingerId", finger_id },
                { "servoId1", list.Count > 0 ? list[0] : string.Empty },
                { "servoId2", list.Count > 1 ? list[1] : string.Empty },
                { "remarks",  list.Count > 0 ? list[^1] : string.Empty } // 若接口最后一项是 remarks
            };

            foreach (var kvp in inputValues)
            {
                var input = scannerInputs.FirstOrDefault(i => i.Id == kvp.Key);
                if (input != null) input.Value = kvp.Value;
            }

            _fingerDto.type = list.Count > 1 ? 4 : 3;

            var servo2Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId2");
            if (servo2Input != null)
            {
                servo2Input.Visible = (_fingerDto.type == 4);
                if (_fingerDto.type != 4) servo2Input.Value = "";
            }

            _servoId1 = list.Count > 0 ? list[0] : "";
            _servoId2 = list.Count > 1 ? list[1] : "";

            StateHasChanged();

            if (scanner is not null)
                await scanner.RevalidateDuplicates();

            // ✅ 回填后做一次校验，避免显示“看起来没错但其实格式不对”
            ValidatePrefixForField("fingerId");
            ValidatePrefixForField("servoId1");
            if (_fingerDto.type == 4) ValidatePrefixForField("servoId2");

            RequestFocusToFirstInput();
        }
    }

    private async Task SetFingerTypeAsync(int t)
    {
        _fingerDto.type = t; // 3=单舵机；4=双舵机

        var servo2Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId2");
        if (servo2Input != null)
        {
            servo2Input.Visible = (t == 4);
            if (t != 4) servo2Input.Value = "";
        }

        StateHasChanged();

        if (scanner is not null)
            await scanner.RevalidateDuplicates();

        // 切换后回到第一个输入框
        RequestFocusToFirstInput();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isLoading = true;
            StateHasChanged();
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("enterKeyHandler.initialize", dotNetRef);

            try
            {
                currentUser = await AuthService.GetCurrentUserAsync();
                if (currentUser == null)
                {
                    NavManager.NavigateTo("/login", true);
                    return;
                }

                _fingerDto.operator_id = currentUser.employee_id;

                if (string.IsNullOrWhiteSpace(taskId))
                {
                    var saved = await JSRuntime.InvokeAsync<string>("localStorage.getItem", StorageKey);
                    if (!string.IsNullOrWhiteSpace(saved))
                    {
                        taskId = saved;
                        hasSearched = true;
                        await LoadTaskDetail();
                    }
                }
            }
            catch
            {
                NavManager.NavigateTo("/login", true);
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }

        if (!firstRender && _pendingFocusId is not null)
        {
            var id = _pendingFocusId;
            _pendingFocusId = null;
            await FocusInputById(id, selectAll: true);
        }
    }

    private void HandleSpecialInputFocus()
    {
        ScannerService.SetCurrentFocusedInputId("taskId");
        _ = ScannerService.ExitAutoFocusModeAsync();
    }

    private async Task HandleSpecialInputBlur()
    {
        if (ScannerService.IsAutoMode) await ScannerService.EnterAutoFocusModeAsync();
        await ScannerService.HandleInputBlurAsync();
    }

    private async Task ClearTaskId()
    {
        taskId = string.Empty;
        task = null;
        hasSearched = false;
        hasInputError = false;
        finishedFingers.Clear();

        _fingerDto = new AddFingerDto { type = 3 };

        foreach (var input in scannerInputs) input.Value = string.Empty;

        _servoId1 = string.Empty;
        _servoId2 = string.Empty;

        if (currentUser != null) _fingerDto.operator_id = currentUser.employee_id;

        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", StorageKey);
        StateHasChanged();

        if (scanner is not null)
            await scanner.RevalidateDuplicates();

        // ✅ 清空后清掉错误提示
        ValidatePrefixForField("fingerId");
        ValidatePrefixForField("servoId1");
        ValidatePrefixForField("servoId2");
    }

    private async Task LoadTaskDetail()
    {
        if (string.IsNullOrWhiteSpace(taskId))
        {
            hasInputError = true;
            StateHasChanged();
            return;
        }

        hasInputError = false;
        isLoading = true;
        StateHasChanged();

        try
        {
            hasSearched = true;
            StateHasChanged();

            task = await TaskService.GetTaskDetail(taskId);
            if (task == null) SnackbarHelper.Show(Snackbar, "生产单号不存在", Severity.Warning);

            _fingerDto.task_id = taskId;

            await JSRuntime.InvokeVoidAsync("localStorage.setItem", StorageKey, taskId);
            await GetFinishedList();

            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            task = null;
            await DialogService.ShowMessageBox("错误", $"任务加载失败：{ex.Message}", "确定");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GetFinishedList()
    {
        try
        {
            var result = await ProcessTwoService.GetFinishedList(taskId);
            finishedFingers = result;

            if (task != null)
            {
                if (finishedFingers.Count >= (task.product_num * 3))
                    await TaskService.UpdateTaskProcessStatus(taskId, "process5", 1);
                else
                    await TaskService.UpdateTaskProcessStatus(taskId, "process5", 0);
            }
        }
        catch
        {
            finishedFingers = new List<FingerDto>();
            SnackbarHelper.Show(Snackbar, "加载失败", Severity.Error);
        }
    }

    private async Task NavigateToDetail()
    {
        if (!string.IsNullOrWhiteSpace(taskId))
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", StorageKey, taskId);

        NavManager.NavigateTo($"/TaskDetail/{taskId}/{3}");
    }

    private async Task HandleAnyInputBlur(string inputId)
    {
        await Task.CompletedTask;
    }

    private async Task HandleBinding()
    {
        var fingerIdInput = scannerInputs.FirstOrDefault(i => i.Id == "fingerId");
        var servo1Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId1");
        var servo2Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId2");
        var remarksInput = scannerInputs.FirstOrDefault(i => i.Id == "remarks");

        if (fingerIdInput == null || string.IsNullOrWhiteSpace(fingerIdInput.Value))
        {
            await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id, "绑定失败 - 手指编号为空", false);
            SnackbarHelper.Show(Snackbar, "请输入手指外壳编号", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        if (servo1Input == null || string.IsNullOrWhiteSpace(servo1Input.Value))
        {
            await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                $"绑定失败 - 手指编号: {fingerIdInput.Value}, 舵机1编号为空", false);
            SnackbarHelper.Show(Snackbar, "请输入舵机1编号", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        if (_fingerDto.type == 4 && (servo2Input == null || string.IsNullOrWhiteSpace(servo2Input.Value)))
        {
            await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                $"绑定失败 - 手指编号: {fingerIdInput.Value}, 舵机2编号为空(双舵机手指)", false);
            SnackbarHelper.Show(Snackbar, "请输入舵机2编号", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        // 本地校验
        ValidatePrefixForField("fingerId");
        ValidatePrefixForField("servoId1");
        if (_fingerDto.type == 4) ValidatePrefixForField("servoId2");

        bool hasError = scannerInputs.Any(i => i.Visible && i.Error);
        if (hasError)
        {
            SnackbarHelper.Show(Snackbar, "存在编号格式错误，请修正后再绑定", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        // 去重拦截（只对可见舵机输入）
        if (scannerInputs
            .Where(i => DuplicateCheckList.Contains(i.Id) && i.Visible)
            .Any(i => i.Error && !string.IsNullOrWhiteSpace(i.ErrorText)))
        {
            SnackbarHelper.Show(Snackbar, "存在重复的舵机编号，请先修改后再绑定", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        isBinding = true;
        try
        {
            _fingerDto.finger_id = fingerIdInput.Value;
            _fingerDto.remarks = remarksInput?.Value ?? "";

            var req = new ServoBindFingerDto
            {
                finger_id = _fingerDto.finger_id,
                task_id = _fingerDto.task_id,
                operator_id = _fingerDto.operator_id,
                remarks = _fingerDto.remarks,
                servo_id1 = servo1Input.Value,
                servo_id2 = (_fingerDto.type == 4 && servo2Input != null) ? servo2Input.Value : ""
            };

            var res = await IPartService.ServoBindFingerAsync(req);

            if (res.ResultCode == 1)
            {
                await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                    $"绑定成功 - 手指编号: {_fingerDto.finger_id}, 任务单号: {_fingerDto.task_id}, 舵机: 1({servo1Input.Value})"
                    + (_fingerDto.type == 4 ? $" 2({servo2Input?.Value})" : ""),
                    true);

                fingerIdInput.Value = "";
                servo1Input.Value = "";
                if (servo2Input != null) servo2Input.Value = "";
                if (remarksInput != null) remarksInput.Value = "";

                if (scanner is not null)
                    await scanner.RevalidateDuplicates();

                SnackbarHelper.Show(Snackbar, "绑定成功", Severity.Success);
                RequestFocusToFirstInput();
            }
            else
            {
                await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                    $"绑定失败 - 手指编号: {_fingerDto.finger_id}, 任务单号: {_fingerDto.task_id}",
                    false);

                SnackbarHelper.Show(Snackbar, $"绑定失败:{res.Msg}", Severity.Error);
                RequestFocusToFirstInput();
            }
        }
        catch (JsonException jsonEx)
        {
            await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                $"绑定JSON解析失败 - 手指编号: {_fingerDto.finger_id}, 任务单号: {_fingerDto.task_id}, 错误信息: {jsonEx.Message}",
                false);

            SnackbarHelper.Show(Snackbar, $"数据解析失败: {jsonEx.Message}", Severity.Error);
            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            await LogService.AddLog("舵机绑定手指", _fingerDto.operator_id,
                $"绑定异常 - 手指编号: {_fingerDto.finger_id}, 任务单号: {_fingerDto.task_id}, 异常信息: {ex.Message}",
                false);

            SnackbarHelper.Show(Snackbar, $"绑定失败:{ex}", Severity.Error);
            RequestFocusToFirstInput();
        }
        finally
        {
            isBinding = false;
            await LoadTaskDetail();
        }
    }

    private async Task HandleInputValueChanged(BarcodeScanner.InputField input)
    {
        switch (input.Id)
        {
            case "fingerId": _fingerDto.finger_id = input.Value; break;
            case "servoId1": _servoId1 = input.Value; break;
            case "servoId2": _servoId2 = input.Value; break;
            case "remarks":  _fingerDto.remarks = input.Value; break;
        }

        ValidatePrefixForField(input.Id);
        await Task.CompletedTask;
    }

    private BarcodeScanner.InputField? DetermineTargetInput(string barcodeData)
    {
        var code = Norm(barcodeData);

        // ✅ finger：只要是 MO-YYYYMMDD-XXX-#### 就进 fingerId
        if (FingerCodeRegex.IsMatch(code))
        {
            return scannerInputs.FirstOrDefault(i => i.Id == "fingerId");
        }

        // servo：按前缀自动落位
        if (code.StartsWith(ServoPrefix, StringComparison.OrdinalIgnoreCase) ||
            code.StartsWith(RotaryServoPrefix, StringComparison.OrdinalIgnoreCase))
        {
            var s1 = scannerInputs.FirstOrDefault(i => i.Id == "servoId1" && string.IsNullOrEmpty(Norm(i.Value)));
            if (s1 != null) return s1;

            if (_fingerDto.type == 4)
            {
                var s2 = scannerInputs.FirstOrDefault(i => i.Id == "servoId2" && i.Visible && string.IsNullOrEmpty(Norm(i.Value)));
                if (s2 != null) return s2;
            }

            return scannerInputs.FirstOrDefault(i => i.Id == "servoId1");
        }

        // 兜底：哪个空填哪个
        var fingerEmpty = scannerInputs.FirstOrDefault(i => i.Id == "fingerId" && string.IsNullOrEmpty(Norm(i.Value)));
        if (fingerEmpty != null) return fingerEmpty;

        var servo1Empty = scannerInputs.FirstOrDefault(i => i.Id == "servoId1" && string.IsNullOrEmpty(Norm(i.Value)));
        if (servo1Empty != null) return servo1Empty;

        if (_fingerDto.type == 4)
        {
            var servo2Empty = scannerInputs.FirstOrDefault(i => i.Id == "servoId2" && i.Visible && string.IsNullOrEmpty(Norm(i.Value)));
            if (servo2Empty != null) return servo2Empty;
        }

        return scannerInputs.FirstOrDefault(i => i.Id == "fingerId");
    }

    private async Task HandleUpdateDemo()
    {
        var fingerIdInput = scannerInputs.FirstOrDefault(i => i.Id == "fingerId");
        var servo1Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId1");
        var servo2Input = scannerInputs.FirstOrDefault(i => i.Id == "servoId2");
        var remarksInput = scannerInputs.FirstOrDefault(i => i.Id == "remarks");

        if (fingerIdInput == null || string.IsNullOrWhiteSpace(fingerIdInput.Value))
        {
            SnackbarHelper.Show(Snackbar, "手指外壳编号不能为空", Severity.Warning);
            RequestFocusToFirstInput();
            return;
        }

        try
        {
            var originalData = await ProcessTwoService.GetFingerDetail(fingerIdInput.Value);

            var newServo1 = servo1Input?.Value ?? "";
            var newServo2 = servo2Input?.Value ?? "";

            var originalServo1 = originalData.Count > 0 ? originalData[0] : "";
            var originalServo2 = originalData.Count > 1 ? originalData[1] : "";

            await CheckAndShowServoChange("舵机1", originalServo1, newServo1);

            if (_fingerDto.type == 4)
                await CheckAndShowServoChange("舵机2", originalServo2, newServo2);

            if (scanner is not null)
                await scanner.RevalidateDuplicates();

            SnackbarHelper.Show(Snackbar, "更新检查完成", Severity.Success);
            RequestFocusToFirstInput();
        }
        catch (Exception ex)
        {
            SnackbarHelper.Show(Snackbar, $"检查异常：{ex.Message}", Severity.Error);
            RequestFocusToFirstInput();
        }
    }

    private async Task CheckAndShowServoChange(string servoName, string oldValue, string newValue)
    {
        if (oldValue != newValue)
        {
            SnackbarHelper.Show(Snackbar, $"{servoName}从'{oldValue}'变更为'{newValue}'", Severity.Info);
        }
        await Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetRef != null)
        {
            await JSRuntime.InvokeVoidAsync("enterKeyHandler.dispose");
            dotNetRef.Dispose();
        }

        GC.SuppressFinalize(this);
    }
}

@inject BarcodeScannerService ScannerService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inject AuthService AuthService
@inject TaskService TaskService
@inject ProcessTwoService ProcessTwoService
@inject ProcessOneService ProcessOneService
@inject LogService LogService
@inject IDX023Service Idx023Service
