@page "/DataSummary"
@using DocumentFormat.OpenXml.Wordprocessing
@using Color = MudBlazor.Color
@inject IServiceProvider ServiceProvider
@inject IJSRuntime JS
<MudPaper Elevation="3" Class="pa-4 ma-2 mx-md-8">

    <MudFadeTransition Visible="@hasSearched">
        <div class="min-vh-40 d-flex flex-column justify-center">

            @if (!hasSearched)
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="text-center mt-8">
                    请输入生产单号并点击查询，加载任务详情
                </MudText>
            }
            else if (isLoading)
            {
                <div class="d-flex justify-content-center align-items-center">
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
                </div>
            }
            else if (fullTaskData == null || !fullTaskData.Any())
            {
                <div class="d-flex justify-content-center align-items-center text-center my-10">
                    <MudIcon Icon="@Icons.Material.Filled.WarningAmber" Color="Color.Error" Size="Size.Large"
                             Class="mr-3"/>
                    <MudText Typo="Typo.body1" Color="Color.Error">
                        无法加载任务数据，请检查生产单号是否正确
                    </MudText>
                </div>
            }
            else
            {
                <MudPaper Elevation="2" Class="mb-4 px-4 py-3 d-flex align-center justify-between flex-wrap">

                    <!-- 左侧：任务详情文字 -->
                    <div class="d-flex flex-wrap align-center gap-4">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.TaskAlt" Color="Color.Primary" Size="Size.Medium"
                                     Class="mr-1"/>
                            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mr-2">任务详情</MudText>
                        </div>

                        <MudText Typo="Typo.body1" Class="mx-2">
                            <b>任务单号：</b>@(fullTaskData?.FirstOrDefault()?.task?.task_id ?? "—")
                        </MudText>

                        <MudText Typo="Typo.body1" Class="mx-2">
                            <b>产品数量：</b>@(fullTaskData?.FirstOrDefault()?.task?.product_num ?? 0)
                        </MudText>

                        <MudText Typo="Typo.body1" Class="mx-2">
                            <b>创建时间：</b>@(fullTaskData?.FirstOrDefault()?.task?.created_at.ToString("yyyy-MM-dd HH:mm") ?? "—")
                        </MudText>
                    </div>

                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               OnClick="ExportExcel"
                               Size="Size.Medium">
                        导出 Excel
                    </MudButton>
                </MudPaper>


                @foreach (var palmData in fullTaskData)
                {
                    var palmTitle = $"手掌信息：{palmData.palm?.palm_id ?? "未知"}";

                    <MudExpansionPanels Elevation="2" Class="mb-5">
                        <MudExpansionPanel Text="@palmTitle"
                                           ExpandIcon="@Icons.Material.Filled.ExpandMore"
                                           CollapseIcon="@Icons.Material.Filled.ExpandLess">
                            <div class="pl-2">

                                <!-- Palm 检测部分可折叠 -->
                                <MudExpansionPanels Elevation="1" Class="my-3">
                                    <MudExpansionPanel Text="整手标定检测"
                                                       ExpandIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                                       CollapseIcon="@Icons.Material.Filled.KeyboardArrowUp">
                                        <MudTable Items="palmData.detects" Dense="true" Hover="true" Bordered="true">
                                            <HeaderContent>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel SortBy="(PalmCalibrateDetectDto x) => x.id">
                                                        检测ID
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel SortBy="(PalmCalibrateDetectDto x) => x.palm_id">
                                                        手掌外壳ID
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.proximity_sensing">
                                                        接近觉
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.normal_force">法向力
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.fan_function">
                                                        风扇功能
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.software_version">
                                                        软件版本号
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.electricity">电流
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.inspector">检测人员
                                                    </MudTableSortLabel>
                                                </MudTh>

                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel SortBy="(PalmCalibrateDetectDto x) => x.remarks">
                                                        备注
                                                    </MudTableSortLabel>
                                                </MudTh>
                                                <MudTh Style="@MinColWidthStyle">
                                                    <MudTableSortLabel
                                                        SortBy="(PalmCalibrateDetectDto x) => x.if_qualified">
                                                        是否合格
                                                    </MudTableSortLabel>
                                                </MudTh>
                                            </HeaderContent>
                                            <RowTemplate>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="检测ID">@context.id</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="手掌外壳ID">@context.palm_id</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="接近觉">@context.proximity_sensing</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="法向力">@context.normal_force</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="风扇功能">@context.fan_function</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="软件版本号">@context.software_version</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="电流">@context.electricity</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="操作员ID">@context.inspector</MudTd>
                                                <MudTd Style="@MinColWidthStyle"
                                                       DataLabel="备注">@context.remarks</MudTd>
                                                <MudTd>
                                                    @if (context.if_qualified == true)
                                                    {
                                                        <span>✅ 合格</span>
                                                    }
                                                    else if (context.if_qualified == false)
                                                    {
                                                        <span>❌ 不合格</span>
                                                    }
                                                    else
                                                    {
                                                        <span>未知</span>
                                                    }
                                                </MudTd>
                                            </RowTemplate>
                                        </MudTable>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>

                                <!-- 手指部分 -->
                                @foreach (var fingerData in palmData.fingers)
                                {
                                    string fingerTypeText = fingerData.finger?.type switch
                                    {
                                        2 => "分指",
                                        1 => "拇指",
                                        0 => "单指",
                                        _ => "未知类型"
                                    };
                                    var fingerTitle = $"{fingerTypeText}编号：{fingerData.finger?.finger_id ?? "未知"}";

                                    <MudExpansionPanels Elevation="1" Class="mt-4">
                                        <MudExpansionPanel Text="@fingerTitle"
                                                           ExpandIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                                           CollapseIcon="@Icons.Material.Filled.KeyboardArrowUp">
                                            <div class="pl-2">
                                                @if (fingerData.finger?.type == 2)
                                                {
                                                    <MudText Typo="Typo.subtitle1" Class="mb-2">分指标定检测
                                                    </MudText>
                                                    <MudTable Items="fingerData.detect3" Dense="true" Hover="true"
                                                              Bordered="true">
                                                        <HeaderContent>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.id">
                                                                    检测ID
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.finger_id">
                                                                    手指外壳ID
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.electricity">
                                                                    电流记录
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.test_action">
                                                                    测试动作
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.begin_time">
                                                                    动作发起时间
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.finish_time">
                                                                    动作结束时间
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.consume_time">
                                                                    耗时（秒）
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.near_angle">
                                                                    近端关节角度
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.remote_angle">
                                                                    远端关节角度
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.motor_1_max">
                                                                    电机1电流峰值
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.motor_2_max">
                                                                    电机2电流峰值
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.inspector">
                                                                    检测人员
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.calibrate_time">
                                                                    标记日期
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.remarks">备注
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitCalibrateDetectDto x) => x.if_qualified">
                                                                    是否合格
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                        </HeaderContent>
                                                        <RowTemplate>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="检测ID">@context.id</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="分指机构外壳ID">@context.finger_id</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电流记录">@context.electricity</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="测试动作">@context.test_action</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="动作发起时间">@context.begin_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="动作结束时间">@context.finish_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="耗时（秒）">@context.consume_time</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="近端关节角度">@context.near_angle</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="远端关节角度">@context.remote_angle</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电机1电流峰值">@context.motor_1_max</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电机2电流峰值">@context.motor_2_max</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="检测人员">@context.inspector</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="标记日期">@context.calibrate_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="备注">@context.remarks</MudTd>
                                                            <MudTd>
                                                                @if (context.if_qualified == true)
                                                                {
                                                                    <span>✅ 合格</span>
                                                                }
                                                                else if (context.if_qualified == false)
                                                                {
                                                                    <span>❌ 不合格</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>未知</span>
                                                                }
                                                            </MudTd>
                                                        </RowTemplate>
                                                    </MudTable>

                                                    <MudText Typo="Typo.subtitle1" Class="mt-3 mb-2">
                                                        分指蜗杆粘接检测
                                                    </MudText>
                                                    <MudTable Items="fingerData.detect2" Dense="true" Hover="true"
                                                              Bordered="true">
                                                        <HeaderContent>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.id">
                                                                    检测ID
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.finger_id">
                                                                    分指ID
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.combine_time">
                                                                    粘接时间
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.using_time">使用时间
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.inspector">检测员
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.if_qualified">
                                                                    是否合格
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                <MudTableSortLabel
                                                                    SortBy="(SplitWormDetectDto x) => x.remarks">备注
                                                                </MudTableSortLabel>
                                                            </MudTh>
                                                        </HeaderContent>
                                                        <RowTemplate>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="序号">@context.id</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="分指ID">@context.finger_id</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="粘合时间">@context.combine_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="使用时间">@context.using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="检测人员">@context.inspector</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="备注">@context.remarks</MudTd>
                                                            <MudTd>
                                                                @if (context.if_qualified)
                                                                {
                                                                    <span>✅ 合格</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>❌ 不合格</span>
                                                                }
                                                            </MudTd>

                                                        </RowTemplate>
                                                    </MudTable>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.subtitle1" Class="mt-2 mb-2">单指标定检测
                                                    </MudText>
                                                    <MudTable Items="fingerData.detect4" Dense="true" Hover="true"
                                                              Bordered="true">
                                                        <HeaderContent>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                检测ID
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                电机使用时间
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                手指使用时间
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                安装时间判定
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                电流记录
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                测试动作
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                动作发起时间
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                动作结束时间
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                耗时（秒）
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                近端关节角度
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                远端关节角度
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                电机1电流峰值
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                电机2电流峰值
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                标记日期
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                接近觉
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                法向力
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                是否合格
                                                            </MudTh>
                                                            <MudTh Style="@MinColWidthStyle">
                                                                备注
                                                            </MudTh>
                                                        </HeaderContent>
                                                        <RowTemplate>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="序号">@context.id</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电机使用时间">@context.motor_using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="手指使用时间">@context.finger_using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle" DataLabel="安装时间判定">
                                                                <MudChip T="bool?"
                                                                         Color="@(context.if_time_qualified.GetValueOrDefault() ? Color.Success : Color.Error)">
                                                                    @(context.if_time_qualified.HasValue ? (context.if_time_qualified.Value ? "是" : "否") : "未知")
                                                                </MudChip>
                                                            </MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电流记录">@context.electricity</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="测试动作">@context.test_action</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="动作发起时间">@context.begin_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="动作结束时间">@context.finish_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="耗时（秒）">@context.consume_time</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="近端关节角度">@context.near_angle</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="远端关节角度">@context.remote_angle</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电机1电流峰值">@context.motor_1_max</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="电机2电流峰值">@context.motor_2_max</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="标记日期">@context.calibrate_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="接近觉">@context.proximity_sensing</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="法向力">@context.normal_force</MudTd>
                                                            <MudTd Style="@MinColWidthStyle"
                                                                   DataLabel="备注">@context.remarks</MudTd>
                                                            <MudTd>
                                                                @if (context.if_qualified == true)
                                                                {
                                                                    <span>✅ 合格</span>
                                                                }
                                                                else if (context.if_qualified == false)
                                                                {
                                                                    <span>❌ 不合格</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>未知</span>
                                                                }
                                                            </MudTd>
                                                        </RowTemplate>
                                                    </MudTable>
                                                }

                                                <MudDivider Class="my-3"/>
                                                <MudText Typo="Typo.subtitle1" Class="mb-2">电机数据</MudText>

                                                @foreach (var motorData in fingerData.motors)
                                                {
                                                    <MudCard Elevation="0" Class="ml-2 mb-3 pa-3" Outlined="true">
                                                        <MudText Typo="Typo.subtitle2" Color="Color.Primary"
                                                                 Class="mb-2">
                                                            电机: @motorData.motor?.motor_id
                                                        </MudText>

                                                        <MudTable Items="@(new[] { motorData.motor })" Dense="true"
                                                                  Hover="true" Bordered="true">
                                                            <HeaderContent>
                                                                <MudTh>电机ID</MudTh>
                                                                <MudTh>任务号</MudTh>
                                                                <MudTh>粘接时间</MudTh>
                                                                <MudTh>绑定时间</MudTh>
                                                                <MudTh>操作员</MudTh>
                                                                <MudTh>备注</MudTh>
                                                                <MudTh>是否合格</MudTh>
                                                            </HeaderContent>
                                                            <RowTemplate>
                                                                <MudTd>@context.motor_id</MudTd>
                                                                <MudTd>@context.task_id</MudTd>
                                                                <MudTd>@context.created_at.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                                                                <MudTd>@context.updated_at?.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                                                                <MudTd>@context.operator_id</MudTd>
                                                                <MudTd>@context.remarks</MudTd>
                                                                <MudTd>@(context.is_qualified ? "✅ 合格" : "❌ 不合格")</MudTd>
                                                            </RowTemplate>
                                                        </MudTable>

                                                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">蜗杆粘接检测
                                                        </MudText>
                                                        <MudTable Items="motorData.detects" Dense="true" Hover="true"
                                                                  Bordered="true">
                                                            <HeaderContent>
                                                                <MudTh>编号</MudTh>
                                                                <MudTh>作用力</MudTh>
                                                                <MudTh>检测前距离</MudTh>
                                                                <MudTh>检测后距离</MudTh>
                                                                <MudTh>距离差</MudTh>
                                                                <MudTh>粘结时间</MudTh>
                                                                <MudTh>使用时间</MudTh>
                                                                <MudTh>检测员</MudTh>
                                                                <MudTh>备注</MudTh>
                                                                <MudTh>是否合格</MudTh>
                                                            </HeaderContent>
                                                            <RowTemplate>
                                                                <MudTd DataLabel="编号">@context.id</MudTd>
                                                                <MudTd DataLabel="作用力">@context.force</MudTd>
                                                                <MudTd
                                                                    DataLabel="检测前距离">@context.distance_before</MudTd>
                                                                <MudTd
                                                                    DataLabel="检测后距离">@context.distance_after</MudTd>
                                                                <MudTd
                                                                    DataLabel="距离差">@context.distance_result</MudTd>
                                                                <MudTd
                                                                    DataLabel="创建时间">@context.combine_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                                <MudTd
                                                                    DataLabel="更新时间">@context.using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                                                <MudTd
                                                                    DataLabel="操作员ID">@context.inspector_id</MudTd>
                                                                <MudTd DataLabel="备注">@context.remarks</MudTd>
                                                                <MudTd>
                                                                    @if (context.if_qualified)
                                                                    {
                                                                        <span>✅ 合格</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>❌ 不合格</span>
                                                                    }
                                                                </MudTd>
                                                            </RowTemplate>
                                                        </MudTable>
                                                    </MudCard>
                                                }
                                            </div>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }
                            </div>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            }
        </div>
    </MudFadeTransition>

    <MudDivider Class="my-6"/>

    <MudStack Row="true" Spacing="4" Class="d-flex align-center py-2">
        <MudTextField
            @bind-Value="taskId"
            Label="生产单号"
            Variant="Variant.Outlined"
            Required="true"
            Clearable="true"
            Error="@hasInputError"
            ErrorText="请输入生产单号"
            AutoFocus="true"
            Id="taskId"
            Class="flex-1"/>

        <MudButton
            Variant="Variant.Filled"
            Color="Color.Error"
            StartIcon="@Icons.Material.Filled.DeleteForever"
            OnClick="ClearTaskId"
            Size="Size.Large"
            Class="w-full md:w-auto">
            清除
        </MudButton>
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Primary"
            StartIcon="@Icons.Material.Filled.Search"
            OnClick="LoadTaskDetail"
            Size="Size.Large"
            Disabled="isLoading"
            Class="w-full md:w-auto">
            @(isLoading ? "查询中..." : "查询")
        </MudButton>
    </MudStack>

</MudPaper>

@code {
    private string TableBodyMaxHeight => "600px";
    private const int MinColWidthPx = 140;
    private string MinColWidthStyle => $"min-width:{MinColWidthPx}px;";

    private string taskId = string.Empty;
    private bool hasInputError = false;
    private bool isLoading = false;
    private bool hasSearched = false;
    private List<FullTaskDataDto> fullTaskData = new();

    private async Task LoadTaskDetail()
    {
        if (string.IsNullOrWhiteSpace(taskId))
        {
            hasInputError = true;
            StateHasChanged();
            return;
        }

        hasInputError = false;
        isLoading = true;
        hasSearched = true;
        StateHasChanged();

        try
        {
            var resp = await TaskService.GetFullTaskData(taskId.Trim());
            fullTaskData = resp ?? new List<FullTaskDataDto>();
        }
        catch
        {
            fullTaskData = new List<FullTaskDataDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearTaskId()
    {
        taskId = string.Empty;
        hasSearched = false;
        hasInputError = false;
        fullTaskData.Clear();
        StateHasChanged();
    }

    private class ExportConstants
    {
        public const string EmptyValue = "—";
        public const string DateFormat = "yyyy-MM-dd HH:mm";
        public const string Qualified = "✅ 合格";
        public const string Unqualified = "❌ 不合格";
    }

    private async Task ExportExcel()
    {
        if (fullTaskData == null || !fullTaskData.Any())
        {
            await JS.InvokeVoidAsync("alert", "没有可导出的数据");
            return;
        }

        try
        {
            // 显示导出中提示
            await JS.InvokeVoidAsync("showLoading", "正在生成Excel文件...");

            // 异步构建数据，避免UI阻塞
            var (rows, merges) = await Task.Run(() => BuildExcelData());

            await JS.InvokeVoidAsync("excel.exportArrayToExcelMerged",
                $"{fullTaskData.FirstOrDefault()?.task?.task_id ?? "任务报告"}.xlsx",
                rows, merges);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"导出失败: {ex.Message}");
        }
        finally
        {
            await JS.InvokeVoidAsync("hideLoading");
        }
    }

    private (List<List<object>> rows, List<object> merges) BuildExcelData()
    {
        var rows = new List<List<object>>();
        var merges = new List<object>();

        BuildTaskDetails(rows);
        BuildPalmFingerMotorRelations(rows, merges);
        BuildDetectionResults(rows);

        return (rows, merges);
    }

    private void BuildTaskDetails(List<List<object>> rows)
    {
        var task = fullTaskData.FirstOrDefault()?.task;

        rows.Add(new() { "任务详情" });
        rows.Add(new() { "任务号", "任务名称", "产品数量", "操作员", "创建时间" });
        rows.Add(new()
        {
            task?.task_id ?? ExportConstants.EmptyValue,
            task?.title ?? ExportConstants.EmptyValue,
            task?.product_num.ToString() ?? ExportConstants.EmptyValue,
            task?.assignee_id ?? ExportConstants.EmptyValue,
            task?.created_at.ToString(ExportConstants.DateFormat)
        });
        rows.Add(new());
    }

    private void BuildPalmFingerMotorRelations(List<List<object>> rows, List<object> merges)
    {
        rows.Add(new() { "手掌-手指-电机 对应关系" });
        rows.Add(new() { "手掌编号", "手指编号", "手指类型", "电机编号", "操作员", "粘接时间", "绑定时间", "是否合格" });

        foreach (var palm in fullTaskData)
        {
            int palmRowStart = rows.Count;

            var orderedFingers = palm.fingers?
                .OrderBy(f => f.finger?.finger_id)
                .ThenBy(f => f.finger?.type)
                .ToList() ?? new();

            foreach (var finger in orderedFingers)
            {
                int fingerRowStart = rows.Count;

                var orderedMotors = finger.motors?
                    .OrderBy(m => m.motor?.motor_id)
                    .ToList() ?? new();

                if (orderedMotors.Count == 0)
                {
                    rows.Add(new()
                    {
                        palm.palm?.palm_id ?? ExportConstants.EmptyValue,
                        finger.finger?.finger_id ?? ExportConstants.EmptyValue,
                        GetFingerTypeText(finger.finger?.type),
                        ExportConstants.EmptyValue,
                        ExportConstants.EmptyValue,
                        ExportConstants.EmptyValue,
                        ExportConstants.EmptyValue,
                        ExportConstants.EmptyValue
                    });
                }
                else
                {
                    foreach (var motor in orderedMotors)
                    {
                        rows.Add(new()
                        {
                            palm.palm?.palm_id ?? ExportConstants.EmptyValue,
                            finger.finger?.finger_id ?? ExportConstants.EmptyValue,
                            GetFingerTypeText(finger.finger?.type),
                            motor.motor?.motor_id ?? ExportConstants.EmptyValue,
                            motor.motor?.operator_id ?? ExportConstants.EmptyValue,
                            motor.motor?.created_at.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                            motor.motor?.updated_at?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                            motor.motor?.is_qualified == true ? ExportConstants.Qualified : ExportConstants.Unqualified
                        });
                    }
                }

                int fingerRowEnd = rows.Count - 1;
                if (fingerRowEnd > fingerRowStart)
                {
                    AddMerge(merges, fingerRowStart, fingerRowEnd, 1); // 合并手指编号
                    AddMerge(merges, fingerRowStart, fingerRowEnd, 2); // 合并手指类型
                }
            }

            int palmRowEnd = rows.Count - 1;
            if (palmRowEnd > palmRowStart)
            {
                AddMerge(merges, palmRowStart, palmRowEnd, 0); // 合并手掌编号
            }
        }

        rows.Add(new());
    }

    private void BuildDetectionResults(List<List<object>> rows)
    {
        rows.Add(new() { "检测结果汇总" });

        var palmDetectRows = BuildPalmDetectionRows();
        var fingerD4Rows = BuildFingerD4Rows();
        var fingerD3Rows = BuildFingerD3Rows();
        var fingerD2Rows = BuildFingerD2Rows();
        var motorWormRows = BuildMotorWormRows();

        // 统一输出检测结果
        AddDetectionSection(rows, "手掌检测", palmDetectRows,
            new[] { "手掌编号", "检测编号", "标定时间","轮指100次", "接近觉", "法向力", "风扇功能", "软件版本", "电流", "检测员", "备注", "是否合格" });

        AddDetectionSection(rows, "单指标定检测", fingerD4Rows,
            new[] { "手指编号", "检测编号", "标定时间", "测试动作", "近端角度", "远端角度", "耗时(s)", "电机1峰值", "电机2峰值","手指电流", "接近觉", "法向力","检测员", "备注", "是否合格" });

        AddDetectionSection(rows, "分指标定检测", fingerD3Rows,
            new[] { "分指编号", "检测编号", "标定时间", "测试动作", "近端角度", "远端角度", "耗时(s)", "电机1峰值", "电机2峰值", "检测员", "备注", "是否合格" });

        AddDetectionSection(rows, "分指蜗杆粘接检测", fingerD2Rows,
            new[] { "分指编号", "检测编号", "粘接时间", "使用时间", "检测员", "备注", "是否合格" });

        AddDetectionSection(rows, "电机蜗杆粘接检测", motorWormRows,
            new[] { "电机编号", "检测编号", "粘接时间", "使用时间", "作用力", "检测前距离", "检测后距离", "距离差", "检测员", "备注", "是否合格" });
    }

    private List<List<object>> BuildPalmDetectionRows()
    {
        var rows = new List<List<object>>();

        foreach (var palm in fullTaskData.Where(p => p?.detects != null))
        {
            foreach (var d in palm.detects)
            {
                rows.Add(new()
                {
                    palm.palm?.palm_id ?? ExportConstants.EmptyValue,
                    d.id,
                    d.calibrate_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                    d.hundred_times?.ToString() ?? ExportConstants.EmptyValue,
                    d.proximity_sensing?.ToString() ?? ExportConstants.EmptyValue,
                    d.normal_force?.ToString() ?? ExportConstants.EmptyValue,
                    d.fan_function?.ToString() ?? ExportConstants.EmptyValue,
                    d.software_version?.ToString() ?? ExportConstants.EmptyValue,
                    d.electricity?.ToString() ?? ExportConstants.EmptyValue,
                    d.inspector?.ToString() ?? ExportConstants.EmptyValue,
                    d.remarks?.ToString() ?? ExportConstants.EmptyValue,
                    d.if_qualified switch
                    {
                        true => ExportConstants.Qualified,
                        false => ExportConstants.Unqualified,
                        null => "未知"
                    }
                });
            }
        }

        return rows;
    }

    private List<List<object>> BuildFingerD4Rows()
    {
        var rows = new List<List<object>>();

        foreach (var palm in fullTaskData.Where(p => p?.fingers != null))
        {
            foreach (var finger in palm.fingers.Where(f => f?.detect4 != null))
            {
                foreach (var d in finger.detect4)
                {
                    rows.Add(new()
                    {
                        finger.finger?.finger_id ?? ExportConstants.EmptyValue,
                        d.id,
                        d.calibrate_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                        d.test_action ?? ExportConstants.EmptyValue,
                        d.near_angle?.ToString() ?? ExportConstants.EmptyValue,
                        d.remote_angle?.ToString() ?? ExportConstants.EmptyValue,
                        d.consume_time?.ToString() ?? ExportConstants.EmptyValue,
                        d.motor_1_max?.ToString() ?? ExportConstants.EmptyValue,
                        d.motor_2_max?.ToString() ?? ExportConstants.EmptyValue,
                        d.electricity?.ToString() ?? ExportConstants.EmptyValue,
                        d.proximity_sensing?.ToString() ?? ExportConstants.EmptyValue,
                        d.normal_force?.ToString() ?? ExportConstants.EmptyValue,
                        d.inspector ?? ExportConstants.EmptyValue,
                        d.remarks ?? ExportConstants.EmptyValue,
                        d.if_qualified switch
                        {
                            true => ExportConstants.Qualified,
                            false => ExportConstants.Unqualified,
                            null => "未知"
                        }
                    });
                }
            }
        }

        return rows;
    }

    private List<List<object>> BuildFingerD3Rows()
    {
        var rows = new List<List<object>>();

        foreach (var palm in fullTaskData.Where(p => p?.fingers != null))
        {
            foreach (var finger in palm.fingers.Where(f => f?.detect3 != null))
            {
                foreach (var d in finger.detect3)
                {
                    rows.Add(new()
                    {
                        finger.finger?.finger_id ?? ExportConstants.EmptyValue,
                        d.id,
                        d.calibrate_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                        d.test_action?.ToString() ?? ExportConstants.EmptyValue,
                        d.near_angle?.ToString() ?? ExportConstants.EmptyValue,
                        d.remote_angle?.ToString() ?? ExportConstants.EmptyValue,
                        d.consume_time?.ToString() ?? ExportConstants.EmptyValue,
                        d.motor_1_max?.ToString() ?? ExportConstants.EmptyValue,
                        d.motor_2_max?.ToString() ?? ExportConstants.EmptyValue,
                        d.inspector ?? ExportConstants.EmptyValue,
                        d.remarks ?? ExportConstants.EmptyValue,
                        d.if_qualified switch
                        {
                            true => ExportConstants.Qualified,
                            false => ExportConstants.Unqualified,
                            null => "未知"
                        }
                    });
                }
            }
        }

        return rows;
    }

    private List<List<object>> BuildFingerD2Rows()
    {
        var rows = new List<List<object>>();

        foreach (var palm in fullTaskData.Where(p => p?.fingers != null))
        {
            foreach (var finger in palm.fingers.Where(f => f?.detect2 != null))
            {
                foreach (var d in finger.detect2)
                {
                    rows.Add(new()
                    {
                        finger.finger?.finger_id ?? ExportConstants.EmptyValue,
                        d.id,
                        d.combine_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                        d.using_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                        d.inspector ?? ExportConstants.EmptyValue,
                        d.remarks ?? ExportConstants.EmptyValue,
                        d.if_qualified ? ExportConstants.Qualified : ExportConstants.Unqualified
                    });
                }
            }
        }

        return rows;
    }


    private List<List<object>> BuildMotorWormRows()
    {
        var rows = new List<List<object>>();

        foreach (var palm in fullTaskData.Where(p => p?.fingers != null))
        {
            foreach (var finger in palm.fingers.Where(f => f?.motors != null))
            {
                foreach (var motor in finger.motors.Where(m => m?.detects != null))
                {
                    foreach (var d in motor.detects)
                    {
                        rows.Add(new()
                        {
                            motor.motor?.motor_id ?? ExportConstants.EmptyValue,
                            d.id,
                            d.combine_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                            d.using_time?.ToString(ExportConstants.DateFormat) ?? ExportConstants.EmptyValue,
                            d.force?.ToString() ?? ExportConstants.EmptyValue,
                            d.distance_before?.ToString() ?? ExportConstants.EmptyValue,
                            d.distance_after?.ToString() ?? ExportConstants.EmptyValue,
                            d.distance_result?.ToString() ?? ExportConstants.EmptyValue,
                            d.inspector_id ?? ExportConstants.EmptyValue,
                            d.remarks ?? ExportConstants.EmptyValue,
                            d.if_qualified ? ExportConstants.Qualified : ExportConstants.Unqualified
                        });
                    }
                }
            }
        }

        return rows;
    }

    private void AddDetectionSection(List<List<object>> rows, string sectionTitle,
        List<List<object>> dataRows, string[] headers)
    {
        if (dataRows.Count > 0)
        {
            rows.Add(new() { sectionTitle });
            rows.Add(new List<object>(headers));
            rows.AddRange(dataRows);
            rows.Add(new());
        }
    }

    private string GetFingerTypeText(int? type)
    {
        return type switch
        {
            0 => "单指",
            1 => "拇指",
            2 => "分指",
            _ => "未知"
        };
    }

    private void AddMerge(List<object> merges, int startRow, int endRow, int col)
    {
        if (endRow <= startRow) return;

        merges.Add(new
        {
            s = new { r = startRow, c = col },
            e = new { r = endRow, c = col }
        });
    }

}
